package is207.connectn.gui;

import is207.connectn.game.Game;
import is207.connectn.game.GameManager;
import is207.connectn.game.GameManager.GameChange;
import is207.connectn.game.GameManager.GameListener;
import is207.connectn.game.GameParams;
import is207.connectn.game.Player;
import is207.connectn.game.Tournament;
import is207.connectn.strategy.StrategyManager;
import java.awt.BorderLayout;
import java.awt.event.ActionEvent;
import javax.swing.AbstractAction;
import javax.swing.Box;
import javax.swing.JButton;
import javax.swing.JComboBox;
import javax.swing.JLabel;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import javax.swing.JTextField;

/**
 *
 * @author evenal
 */
public class ConnectNPanel extends JPanel implements GameListener
{

    JTextField status;
    JTextField colField, rowField, timeoutField, connLenField;
    JLabel gameInfo;

    GameParams gameParams = new GameParams();
    Game game;
    Board board;
    Player winner = null;

    int delay = 1000; //millisec
    StrategyManager stratMgr;
    GameManager gameMgr;
    TournamentResult tournamentResult;

    public ConnectNPanel() {
        setLayout(new BorderLayout());
        Box menu = Box.createVerticalBox();
        menu.add(new JButton(new PlayGameAction()));
        menu.add(new JButton(new PlayTournamentAction()));
        add(menu, BorderLayout.EAST);
        gameInfo = new JLabel(" ");
        add(gameInfo, BorderLayout.NORTH);
        status = new JTextField();
        add(status, BorderLayout.SOUTH);
        board = new Board(gameParams);
        add(board);

        stratMgr = StrategyManager.getInstance();
        gameMgr = new GameManager(gameParams);
        gameMgr.addMoveListener(board);
        gameMgr.addGameOverListener(board);
        gameMgr.addGameOverListener(this);
        gameMgr.addNewGameListener(this);
    }

    @Override
    public void gameChanged(Game game, GameChange reason) {
        if (reason == GameChange.NEW_GAME) {
            Player[] players = game.getPlayers();
            gameInfo.setText(players[0].getName()
                    + " (RED) vs " + players[1].getName() + " (BLUE)");
            board.reset();
        }
        else if (reason == GameChange.GAME_OVER) {
            Player winner = game.getWinner();
            if (null == winner) {
                status.setText("Draw");
            }
            else {
                status.setText(winner.getName() + " won");
            }
        }
    }

    private class PlayTournamentAction extends AbstractAction
    {

        public PlayTournamentAction() {
            super("Tournament");
        }

        public void actionPerformed(ActionEvent e) {
            gameMgr.startTournament();
            displayTournamentResults(gameMgr.getTournament());
        }
    }

    private void displayTournamentResults(Tournament t) {
        if (null == tournamentResult) {
            tournamentResult = new TournamentResult(t);
        }
    }

    private class PlayGameAction extends AbstractAction
    {

        public PlayGameAction() {
            super("Single game...");
        }

        @Override
        public void actionPerformed(ActionEvent e) {
            String[] stratName = selectStrategyNames();
            gameMgr.startGame(stratName[0], stratName[1]);
        }
    }

    private String[] selectStrategyNames() {
        SimpleForm form = new SimpleForm();
        StrategyManager stratMgr = StrategyManager.getInstance();
        String[] strategies = stratMgr.getNames();
        JComboBox<String> stratSelector1 = new JComboBox<>(strategies);
        JComboBox<String> stratSelector2 = new JComboBox<>(strategies);
        form.addComboBox("First player strategy:", stratSelector1);
        form.addComboBox("Second player strategy:", stratSelector2);
        JOptionPane.showConfirmDialog(this,
                form, "Select player strategies:",
                JOptionPane.OK_CANCEL_OPTION);
        String[] strategyNames = new String[]{
            strategies[stratSelector1.getSelectedIndex()],
            strategies[stratSelector2.getSelectedIndex()]
        };

        return strategyNames;
    }
}
