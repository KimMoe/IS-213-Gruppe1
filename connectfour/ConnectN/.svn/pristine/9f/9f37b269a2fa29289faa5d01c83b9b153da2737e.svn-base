package is207.connectn.game.strategy.minimax;

import java.io.IOException;
import java.io.PrintWriter;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.LinkedList;



public class Board
{
    int rows, cols;
    public int[][] state;
    public int[] h;
    LinkedList<StackNode> moveStack;
    int moveCount;

    private static PrintWriter log;

    public Board(int rows, int cols) {
        moveCount = 0;
        this.rows = rows;
        this.cols = cols;
        moveStack = new LinkedList<>();
        h = new int[cols];
        state = new int[rows][cols];
        for (int r = 0; r < rows; r++)
            for (int c = 0; c < cols; c++) {
                state[r][c] = 0;
                h[c] = 0;
            }
        try {
            log = new PrintWriter("board.log");
        }
        catch (IOException e) {

        }
    }

    public ArrayList<Integer> getLegalMoves() {
        ArrayList<Integer> moves = new ArrayList<>();
        for (int i = 0; i < cols; i++)
            if (h[i] < rows) moves.add(i);
        return moves;
    }

    public Board clone() {
        Board clone = new Board(rows, cols);
        for (int r = 0; r < rows; r++)
            for (int c = 0; c < cols; c++) {
                clone.state[r][c] = this.state[r][c];
                clone.h[c] = this.h[c];
            }
        return clone;
    }

    @Override
    public int hashCode() {
        int hash = 3;
        hash = 37 * hash + Arrays.deepHashCode(this.state);
        hash = 37 * hash + Arrays.hashCode(this.h);
        return hash;
    }

    @Override
    public boolean equals(Object obj) {
        if (obj == null) return false;
        if (getClass() != obj.getClass()) return false;
        final Board other = (Board) obj;
        if (!Arrays.deepEquals(this.state, other.state))
            return false;
        if (!Arrays.equals(this.h, other.h)) return false;
        return true;
    }

    public void doMove(int move, int player) {
        assert player == 1 || player == -1;
        int c = move;
        int r = h[c];
        moveStack.addFirst(new StackNode(player, r, c));
        assert player == 1 || player == -1;
        assert r >= 0 && r < rows && c >= 0 && c < cols;
        state[r][c] = player;
        h[c] = r + 1;
        moveCount++;
    }

    public void undoMove() {
        StackNode n = moveStack.removeFirst();
        assert (state[n.row][n.col] == n.player) : "state[" + n.row + "][" + n.col + "] = "
                + state[n.row][n.col] + ", expected " + n.player;
        assert h[n.col] == n.row + 1 : "h[" + n.col + "] = " + h[n.col] + ", expected " + n.row + 1;

        state[n.row][n.col] = 0;
        h[n.col]--;
        moveCount--;
    }

    public void logState(String m, int val) {
        log.println(m + val);
        for (StackNode n : moveStack)
            log.print(" " + n.col);
        log.println();
        log.print("+");
        for (int col = 0; col < cols; col++)
            log.print("-");
        log.println("+");
        for (int row = rows - 1; row >= 0; row--) {
            log.print("|");
            for (int col = 0; col < cols; col++) {
                if (state[row][col] == 1)
                    log.print("O");
                else if (state[row][col] == -1)
                    log.print("X");
                else if (state[row][col] == 0)
                    log.print(".");
                else
                    log.print("?");
                log.println("Unexpected )" + state[row][col]);
            }
            log.println("|");
        }
        log.print("+");
        for (int col = 0; col < cols; col++)
            log.print("-");
        log.println("+");
        log.flush();
    }

}
